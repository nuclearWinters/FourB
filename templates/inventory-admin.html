<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="stylesheet" href="main.css">
</head>
<script type="module" src="main.js"></script>

<body>
  <script type="module">
    import { fetchWrapper, toCurrency, insertHTML } from "./main.js"
    fetchWrapper('https://{{domain}}/inventory')
      .then(json => {
        const loading = document.getElementById("loading")
        if (loading) {
          loading.style.display = "none"
        }
        const list = document.querySelector('#inventory')
        json.forEach(product => {
          insertHTML(
            list,
            `<div class="product-card">
              <form method="PATCH" action="https://{{domain}}/inventory" id="update-product-${product._id}">
                <div class="input-container">
                  <label for="name">Nombre</label>
                  <input id="name-product" name="name" required type="text" value="${product.name}" />
                </div>
                <div class="input-container">
                  <label for="currency-${product._id}">Precio</label>
                  <input id="currency-${product._id}" type="number" pattern="\d*" step="any" name="currency" value="${toCurrency(String(product.price), '.')}" required />
                </div>
                <div class="input-container">
                  <label for="discount-${product._id}">Precio de descuento</label>
                  <div>
                    <input type="checkbox" id="checkboxDiscount" name="checkboxDiscount" ${product.use_discount ? "checked" : ""} />
                    <label for="checkboxDiscount">Usar descuento</label>
                  </div>
                  <input id="discount-${product._id}" type="number" pattern="\d*" step="any" name="discount" value="${toCurrency(String(product.discount_price), '.')}" required />
                </div>
                <div class="input-container">
                  <label for="increment-${product._id}">Añadir al inventario</label>
                  <input id="increment-${product._id}" type="number" value="0" name="increment" />
                </div>
                <img class="img-product" src="${product.img}" />
                <div id="available-${product._id}" class="price">
                  Disponible: ${product.available}</span>
                </div>
                <div id="total-${product._id}" class="price">
                  Total: ${product.total}</span>
                </div>
                <button  type="submit" class="fourb-button" type="submit">Actualizar</button>
                <button type="button" class="fourb-button" onclick="(() => {
                  window.location.href = '/product-${product._id}'
                })()">VER</button>
              </form>
            </div>`
          )
          const priceInput = document.getElementById(`currency-${product._id}`)
          priceInput.oninput = (e) => {
            const valueAsCurrency = toCurrency(e.target.value, '.')
            priceInput.value = valueAsCurrency
          }
          const discountPriceInput = document.getElementById(`discount-${product._id}`)
          discountPriceInput.oninput = (e) => {
            const valueAsCurrency = toCurrency(e.target.value, '.')
            discountPriceInput.value = valueAsCurrency
          }
          const form = document.getElementById(`update-product-${product._id}`)
          const available = document.getElementById(`available-${product._id}`)
          const total = document.getElementById(`total-${product._id}`)
          form.addEventListener("submit", async (e) => {
            try {
              e.preventDefault()
              const data = await fetchWrapper("https://{{domain}}/inventory", {
                method: "PATCH",
                body: JSON.stringify({
                  id: product._id,
                  name: form.name.value,
                  increment: Number(form.increment.value),
                  price: Number(form.currency.value) * 100,
                  discountPrice: Number(form.discount.value) * 100,
                  useDiscount: form.checkboxDiscount.checked,
                })
              })
              available.innerText = `Disponible: ${data.product.available}`
              total.innerText = `Total: ${data.product.total}`
              alert("¡Actualizado con exito!")
            } catch (e) {
              if (e instanceof Error) {
                alert(e.message)
              } else {
                alert("Error")
              }
            }
          })
        })
      });
  </script>
  <fourb-header></fourb-header>
  <h2 class="title">Inventario</h2>
  <h3 class="title">Crear producto</h3>
  <form method="POST" action="https://{{domain}}/inventory" id="create-product">
    <div class="input-container">
      <label for="name">Nombre</label>
      <input id="name-product" name="name" required type="text" />
    </div>
    <div class="input-container">
      <label for="qty">Cantidad</label>
      <input id="qty-product" name="qty" required type="number" />
    </div>
    <div class="input-container">
      <label for="currency">Precio</label>
      <input id="currency" type="number" pattern="\d*" step="any" name="currency" value="0.00" required />
    </div>
    <div class="input-container">
      <label for="discount">Precio de descuento</label>
      <div>
        <input type="checkbox" id="checkboxDiscount" name="checkboxDiscount" />
        <label for="checkboxDiscount">Usar descuento</label>
      </div>
      <input id="discount" type="number" pattern="\d*" step="any" name="discount" value="0.00" required />
    </div>
    <div class="input-container">
      <label for="image">Imagen</label>
      <input name="image" id="file-input" type="file" accept="png,jpg,jpeg" />
    </div>
    <div class="input-container">
      <input type="text" required hidden name="img" id="img-uploaded-input" />
      <img id="img-uploaded" alt="" width="100%" />
    </div>
    <button class="fourb-button" type="submit">Crear</button>
  </form>
  <div class="loading" id="loading"></div>
  <div style="display: flex; justify-content: center; flex-wrap: wrap;" id="inventory"></div>
  <script type="module">
    import { fetchWrapper, toCurrency } from "./main.js"
    const form = document.getElementById("create-product")
    form.addEventListener("submit", async (e) => {
      e.preventDefault()
      try {
        await fetchWrapper("https://{{domain}}/inventory", {
          method: "POST",
          body: JSON.stringify({
            name: form.name.value,
            qty: Number(form.qty.value),
            price: Number(form.currency.value) * 100,
            img: form.img.value,
            discountPrice: Number(form.discount.value) * 100,
            useDiscount: form.checkboxDiscount.checked,
          })
        })
        const imgUploaded = document.getElementById("img-uploaded")
        if (imgUploaded) {
          imgUploaded.src = ""
        }
        form.reset()
      } catch (e) {
        alert(e.message)
      }
    })
    const input = document.getElementById("currency")
    if (input) {
      input.oninput = (e) => {
        const valueAsCurrency = toCurrency(e.target.value, '.')
        input.value = valueAsCurrency
      }
    }
    const discountInput = document.getElementById("discount")
    if (discountInput) {
      discountInput.oninput = (e) => {
        const valueAsCurrency = toCurrency(e.target.value, '.')
        discountInput.value = valueAsCurrency
      }
    }
    const fileInput = document.getElementById("file-input")
    if (fileInput) {
      fileInput.addEventListener("input", async (event) => {
        try {
          const file = event.target.files[0]
          const response = await fetchWrapper("https://{{domain}}/signed-url", {
            method: "POST",
            body: JSON.stringify({
              fileType: file.type,
            })
          })
          const awsResponse = await fetch(response.uploadUrl, {
            method: "PUT",
            body: file,
          })
          const url = new URL(response.uploadUrl);
          const imgUploadedInput = document.getElementById("img-uploaded-input")
          const imgUploaded = document.getElementById("img-uploaded")
          if (imgUploadedInput) {
            imgUploadedInput.value = url.origin + url.pathname
          }
          if (imgUploaded) {
            imgUploaded.src = url.origin + url.pathname
          }
        } catch (e) {
          alert(e.message)
        }
      })
    }
  </script>
</body>

</html>