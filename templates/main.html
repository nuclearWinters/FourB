<!DOCTYPE html>
<html lang="en">
  <head>
    <style>
      .auth-modal {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0,0,0,0.1);
      }
      .auth-form {
        width: 80%;
        height: 80%;
        display: flex;
        flex-direction: column;
        background: white;
      }
    </style>
  </head>
  <body>
    <script>
      if (!sessionStorage.getItem("user_id")) {
        fetch("http://localhost:8000/user", {
          headers: {
            authorization: sessionStorage.getItem("accessToken")
          }
        })
          .then(response => response.json())
          .then(data => {
            if (data._id && data.cart_id) {
              sessionStorage.setItem("user_id", data._id)
              sessionStorage.setItem("cart_id", data.cart_id)
            }
          })
      }
      fetch('http://localhost:8000/inventory')
        .then(response => response.json())
        .then(json => {
          const list = document.querySelector('#products')
          json.forEach(product => {
            const projectEl = document.createElement('div')
            const name = document.createElement('div')
            name.textContent = product.name
            const price = document.createElement('div')
            price.textContent = product.price
            const qty = document.createElement('div')
            qty.textContent = product.qty
            projectEl.appendChild(name)
            projectEl.appendChild(price)
            projectEl.appendChild(qty)
            const viewButton = document.createElement('button')
            viewButton.onclick = () => {
              window.location.href = `/product-${product._id}`;
            }
            viewButton.textContent = "VIEW"
            projectEl.appendChild(viewButton)
            const buyButton = document.createElement('button')
            buyButton.onclick = async () => {
              const response = await fetch('http://localhost:8000/add-to-cart', {
                method: "POST",
                headers: {
                  authorization: sessionStorage.getItem("accessToken"),
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  product_id: product._id,
                  qty: 1
                })
              })
              const data = await response.json()
              if (response.status === 200) {
                alert("Added to cart")
              }
            }
            buyButton.textContent = "ADD TO CART"
            projectEl.appendChild(buyButton)
            list.appendChild(projectEl)
          })
        });
      const logInSubmit = async (e, form) => {
        e.preventDefault();
        try {
          const response = await fetch("http://localhost:8000/log-in", {
            method: 'POST',
            body: JSON.stringify({ email: form.email.value, password: form.password.value}),
            headers: {
              "Content-Type": "application/json"
            }
          })
          if (response.headers.accessToken) {
            sessionStorage("accessToken", response.headers.accessToken)
          }
          const data = await response.json();
          if (response.status !== 200) {
            throw new Error(data)
          }
          if (data._id && data.cart_id) {
            sessionStorage.setItem("user_id", data._id)
            sessionStorage.setItem("cart_id", data.cart_id)
          }
        } catch(e) {
          if (e instanceof Error) {
            alert(e.message)
          } else {
            alert("Error")
          }
        }
      }
      const registerSubmit = async (e, form) => {
        e.preventDefault();
        try {
          const response = await fetch("http://localhost:8000/register", {
            method: 'POST',
            body: JSON.stringify({ email: form.email.value, password: form.password.value}),
            headers: {
              "Content-Type": "application/json"
            }
          })
          if (response.headers.accessToken) {
            sessionStorage("accessToken", response.headers.accessToken)
          }
          const data = await response.json();
          if (response.status !== 200) {
            throw new Error(data)
          }
          if (data._id && data.cart_id) {
            sessionStorage.setItem("user_id", data._id)
            sessionStorage.setItem("cart_id", data.cart_id)
          }
        } catch(e) {
          if (e instanceof Error) {
            alert(e.message)
          } else {
            alert("Error")
          }
        }
      }
      const goToCart = () => {
        window.location.href = "/cart"
      }
    </script>
    <button onclick="goToCart()">Cart</button>
    <button id="show-log-in">Log in</button>
    <button id="show-register">Register</button>
    <div id="register-modal" class="auth-modal" style="display: none;">
      <form action="http://localhost:8000/register" class="auth-form" method="POST" id="form-register" onsubmit="registerSubmit(event, this)">
        <span id="close-register" class="close">x</span>
        <div>Register</div>
        <label for="email">Email</label>
        <input type="text" name="email" required />
        <label for="password">Password</label>
        <input type="password" name="password" required />
        <button type="submit">Register</button>
      </form>
    </div>
    <div id="log-in-modal" class="auth-modal" style="display: none;">
      <form action="http://localhost:8000/log-in"class="auth-form" method="POST" id="form-log-in" onsubmit="logInSubmit(event, this)">
        <span id="close-log-in" class="close">x</span>
        <div>Log in</div>
        <label for="email">Email</label>
        <input type="text" name="email" required />
        <label for="password">Password</label>
        <input type="password" name="password" required />
        <button type="submit">Log In</button>
      </form>
    </div>
    <div>Products</div>
    <div id="products"></div>
    <script>
      const logInModal = document.getElementById("log-in-modal");
      const showLogIn = document.getElementById("show-log-in");
      const closeLogIn = document.getElementById("close-log-in");
      showLogIn.onclick = () => {
        logInModal.style.display = "flex";
      }
      closeLogIn.onclick = () => {
        logInModal.style.display = "none";
      }
      window.onclick = (event) => {
        if (event.target == logInModal) {
          logInModal.style.display = "none";
        }
        if (event.target == registerModal) {
          registerModal.style.display = "none";
        }
      }
      const registerModal = document.getElementById("register-modal");
      const showRegister = document.getElementById("show-register");
      const closeRegister = document.getElementById("close-register");
      showRegister.onclick = () => {
        registerModal.style.display = "flex";
      }
      closeRegister.onclick = () => {
        registerModal.style.display = "none";
      }
    </script>
  </body>
</html>