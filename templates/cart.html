<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="main.css">
  </head>
  <script type="module" src="main.js"></script>
  <body>
    <script type="module">
      import { fetchWrapper } from "./main.js"
      fetchWrapper('https://{{domain}}/add-to-cart')
      .then(json => {
        const list = document.querySelector('#products')
        const payButton = document.getElementById("pay-button")
        if (payButton && !json.length) {
          payButton.innerText = "AÃ±adir productos al carrito"
          payButton.onclick = () => {
            window.location.href = "/"
          }
        }
        const loading = document.getElementById("loading")
        if (loading) {
          loading.style.display = "none"
        }
        payButton.style.display = "block"
        json.forEach((product, idx) => {
          const projectEl = document.createElement('div')
          projectEl.className = "product-card"
          projectEl.id = `${idx}-product`
          const name = document.createElement('div')
          name.className = "name"
          name.textContent = product.name
          const price = document.createElement('div')
          price.className = "price"
          price.textContent = `$${(product.price / 100).toFixed(2)}`
          projectEl.appendChild(name)
          projectEl.appendChild(price)
          const inputContainer = document.createElement("div")
          inputContainer.className = "input-container"
          const label = document.createElement('label')
          label.innerText = "Cantidad"
          const input = document.createElement('input')
          input.type = "number"
          input.id = `${idx}-quantity`
          input.value = product.qty
          input.min = "1"
          inputContainer.appendChild(label)
          inputContainer.appendChild(input)
          const total= document.createElement('div')
          total.innerText = `Total: $${((product.price * product.qty) / 100).toFixed(2)}`
          total.className = "price"
          projectEl.appendChild(inputContainer)
          projectEl.appendChild(total)
          const viewButton = document.createElement('button')
          viewButton.onclick = () => {
            window.location.href = `/product-${product.product_id}`;
          }
          viewButton.textContent = "VER"
          viewButton.className = "fourb-button"
          projectEl.appendChild(viewButton)
          const buyButton = document.createElement('button')
          buyButton.onclick = async () => {
            try {
              const input = document.getElementById(`${idx}-quantity`)
              const data = await fetchWrapper('https://{{domain}}/add-to-cart', {
                method: "PATCH",
                body: JSON.stringify({
                  item_by_cart_id: product._id,
                  product_id: product.product_id,
                  qty: Number(input.value)
                })
              })
              alert("Producto actualizado en el carrito")
            } catch(e) {
              alert(e.message)
            }
          }
          buyButton.textContent = "Actualizar cantidad"
          buyButton.className = "fourb-button"
          projectEl.appendChild(buyButton)
          const deleteButton = document.createElement('button')
          deleteButton.onclick = async () => {
            try {
              const data = await fetchWrapper('https://{{domain}}/add-to-cart', {
                method: "DELETE",
                body: JSON.stringify({
                  item_by_cart_id: product._id,
                })
              })
              const product_id = document.getElementById(`${idx}-product`)
              product_id.remove()
              alert("Producto eliminado con exito")
            } catch(e) {
              alert(e.message)
            }
          }
          deleteButton.textContent = "Eliminar producto"
          deleteButton.className = "fourb-button"
          projectEl.appendChild(deleteButton)
          list.appendChild(projectEl)
        })
      });
    </script>
    <fourb-header></fourb-header>
    <h2 class="title">
      Carro de compras
    </h2>
    <div class="loading" id="loading"></div>
    <div id="products" style="display: flex; flex-wrap: wrap; justify-content: center;"></div>
    <button style="display: none;" class="fourb-button" id="pay-button">Pagar</button>
    <script type="module">
      const button = document.getElementById("pay-button")
      if (button) {
        button.onclick = () => {
          window.location.href = "/checkout"
        }
      }
    </script>
  </body>
</html>